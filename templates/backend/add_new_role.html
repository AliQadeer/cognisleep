{% extends "backend/base.html" %}
{% load static %}
{% load crispy_forms_tags %}


{% block content %}
<style>
    .gap-15 {
        gap: 15px;
    }

    /* accordian */
    #main {
  margin: 25px 0;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header .btn {
    margin-left: auto;
}

.card-header .fa-angle-down {
    font-size: 18px;
    cursor: pointer;
}

.card-body .form-check-inline {
    display: flex;
}

div#w0 form label{
    margin: 1px 0px 0px 0px;
}

/* Pre-loader styling */
#preLoader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
}

</style>
<div class="content-wrap">
    <div class="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-8 p-r-0 title-margin-right">
                    <div class="page-header">
                         <button  style=" margin-top: -2px; margin-bottom: 10px !important;" type="button" class="btn btn-primary mb-2 backbtn" onclick="javascript:history.back()" id="btn_search"><i class="fa fa-angle-left"
                                        aria-hidden="true"></i>Back</button>
                        <div class="page-title">
                            <h1>Add New Role</h1>
                               {% if messages %}
                                {% for message in messages %}
                                    <div style="color:white;font-width: bold;" class="alert alert-{{ message.tags }}">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- /# column -->

                <!-- /# column -->
            </div>
            <!-- /# row -->
            <div class="dashboard-wrapper">
                <div id="w0" class="grid-view">
                        <form id="addEmployeeForm">
                            <div class="row">
                                <div class="col-3" id="roleNameContainer">
                                    <!-- Role Name -->
                                    <div class="form-group">
                                        <label for="roleName">Role Name</label>
                                        <input type="text" class="form-control" id="roleName" name="roleName" placeholder="Enter custom role name" required/>
                                    </div>
                                </div>
                                     <!-- Pre-loader -->
                                <div id="preLoader" style="display: none;">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div id="main">
                                            <div class="accordion" id="permissionsAccordion">
                                                <!-- Dynamic content will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <!-- Submit Button -->
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </div>                           
                        </form>
                   
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}


{% block javascript %}

<script>

document.addEventListener('DOMContentLoaded', function () {
    const RoleNameInput = document.getElementById('roleName');
    const permissionsAccordion = document.getElementById('permissionsAccordion');
    const preLoader = document.getElementById('preLoader');

    let permissionsData = []; // To store permissions data

    fetchPermissions();

    function fetchPermissions() {
        preLoader.style.display = 'flex';

        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://127.0.0.1:8000/Permissions/permissions/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onload = function () {
            preLoader.style.display = 'none';
            if (xhr.status === 200) {
                const response_data = JSON.parse(xhr.responseText);
                console.log('Permissions:', response_data);

                if (response_data.success && response_data.data.length > 0) {
                    permissionsData = response_data.data; // Store permissions data
                    populatePermissions(permissionsData);
                }
            } else {
                console.error('Error fetching permissions:', xhr.statusText);
                alert('Failed to fetch permissions.');
            }
        };

        xhr.onerror = function () {
            preLoader.style.display = 'none';
            console.error('Request failed');
            alert('Request failed.');
        };

        xhr.send();
    }


    function populatePermissions(data) {
        const accordionContainer = document.getElementById('permissionsAccordion');
        accordionContainer.innerHTML = '';

        data.forEach((module, index) => {
            const card = document.createElement('div');
            card.classList.add('card');

            const cardHeader = document.createElement('div');
            cardHeader.classList.add('card-header', 'd-flex', 'justify-content-between', 'align-items-center');
            cardHeader.id = `faqhead${index}`;

            const mainCheckboxWrapper = document.createElement('div');
            mainCheckboxWrapper.classList.add('form-check', 'form-check-inline');

            const mainCheckbox = document.createElement('input');
            mainCheckbox.type = 'checkbox';
            mainCheckbox.classList.add('form-check-input');
            mainCheckbox.id = `mainCheckbox_${index}`;
            mainCheckbox.checked = module.can_access;

            const mainCheckboxLabel = document.createElement('label');
            mainCheckboxLabel.classList.add('form-check-label');
            mainCheckboxLabel.setAttribute('for', `mainCheckbox_${index}`);
            mainCheckboxLabel.innerText = module.module_name;

            mainCheckboxWrapper.appendChild(mainCheckbox);
            mainCheckboxWrapper.appendChild(mainCheckboxLabel);

            const toggleIcon = document.createElement('i');
            toggleIcon.classList.add('fa', 'fa-angle-down');
            toggleIcon.setAttribute('aria-hidden', 'true');

            const toggleLink = document.createElement('a');
            toggleLink.href = '#';
            toggleLink.classList.add('btn', 'collapsed');
            toggleLink.setAttribute('data-toggle', 'collapse');
            toggleLink.setAttribute('data-target', `#faq${index}`);
            toggleLink.setAttribute('aria-expanded', 'false');
            toggleLink.setAttribute('aria-controls', `faq${index}`);

            toggleLink.appendChild(toggleIcon);

            cardHeader.appendChild(mainCheckboxWrapper);
            cardHeader.appendChild(toggleLink);

            const collapseDiv = document.createElement('div');
            collapseDiv.id = `faq${index}`;
            collapseDiv.classList.add('collapse');
            collapseDiv.setAttribute('aria-labelledby', `faqhead${index}`);
            collapseDiv.setAttribute('data-parent', '#permissionsAccordion');

            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body');

            for (let key in module) {
                if (key !== 'module_name') {
                    const permissionCheckboxWrapper = document.createElement('div');
                    permissionCheckboxWrapper.classList.add('form-check', 'form-check-inline');

                    const permissionCheckbox = document.createElement('input');
                    permissionCheckbox.type = 'checkbox';
                    permissionCheckbox.classList.add('form-check-input');
                    permissionCheckbox.id = `${module.module_name}_${key}`;
                    permissionCheckbox.checked = module[key];

                    const permissionLabel = document.createElement('label');
                    permissionLabel.classList.add('form-check-label');
                    permissionLabel.setAttribute('for', `${module.module_name}_${key}`);
                    permissionLabel.innerText = key.replace(/_/g, ' ');

                    permissionCheckboxWrapper.appendChild(permissionCheckbox);
                    permissionCheckboxWrapper.appendChild(permissionLabel);

                    cardBody.appendChild(permissionCheckboxWrapper);
                }
            }

            collapseDiv.appendChild(cardBody);
            card.appendChild(cardHeader);
            card.appendChild(collapseDiv);

            accordionContainer.appendChild(card);

            mainCheckbox.addEventListener('change', function () {
                const checkboxes = collapseDiv.querySelectorAll('.form-check-input');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = mainCheckbox.checked;
                });
            });
        });
    }

   
    document.getElementById('addEmployeeForm').addEventListener('submit', function(event) {
        event.preventDefault();

        let permissions = [];
        permissionsData.forEach(module => {
            const modulePermissions = {};
            for (let key in module) {
                if (key !== 'module_name') {
                    const checkbox = document.getElementById(`${module.module_name}_${key}`);
                    if (checkbox) {
                        modulePermissions[key] = checkbox.checked;
                    }
                }
            }
            if (Object.keys(modulePermissions).length > 0) {
                permissions.push({
                    module_name: module.module_name,
                    ...modulePermissions
                });
            }
        });

        let data = {            
            "name": RoleNameInput.value,
            "permissions": permissions,
        };

        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://127.0.0.1:8000/Permissions/userrolelist/', true); 
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onload = function () {
            if (xhr.status === 200) {
                alert('Employee added successfully');
                window.location.href ="/backend/role_management"
                document.getElementById('addEmployeeForm').reset();
            } else {
                alert('Failed to add employee');
            }
        };
        xhr.send(JSON.stringify(data));
    });
});

</script>

{% endblock %}